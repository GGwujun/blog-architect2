<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-architect2/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-architect2";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>春节加餐｜深入聊一聊计算机系统的时间 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/深入浅出分布式技术原理/03.春节加餐/02" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect2/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>架构师<ul><li><a href="/blog-architect2/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-architect2/消息队列进阶">消息队列进阶</a></li><li><a href="/blog-architect2/分布式协议与算法实战">分布式协议与算法实战</a></li><li><a href="/blog-architect2/分布式技术原理与算法解析">分布式技术原理与算法解析</a></li><li><a href="/blog-architect2/分布式数据库30讲">分布式数据库30讲</a></li><li><a href="/blog-architect2/分布式金融架构课">分布式金融架构课</a></li><li><a href="/blog-architect2/李智慧高并发架构实战课">李智慧高并发架构实战课</a></li><li><a aria-current="page" class="active" href="/blog-architect2/深入浅出分布式技术原理">深入浅出分布式技术原理</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect2/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>架构师<ul><li><a href="/blog-architect2/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-architect2/消息队列进阶">消息队列进阶</a></li><li><a href="/blog-architect2/分布式协议与算法实战">分布式协议与算法实战</a></li><li><a href="/blog-architect2/分布式技术原理与算法解析">分布式技术原理与算法解析</a></li><li><a href="/blog-architect2/分布式数据库30讲">分布式数据库30讲</a></li><li><a href="/blog-architect2/分布式金融架构课">分布式金融架构课</a></li><li><a href="/blog-architect2/李智慧高并发架构实战课">李智慧高并发架构实战课</a></li><li><a aria-current="page" class="active" href="/blog-architect2/深入浅出分布式技术原理">深入浅出分布式技术原理</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-architect2/深入浅出分布式技术原理">深入浅出分布式技术原理</a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/01.开篇词">01.开篇词</a><ul><li><a href="/blog-architect2/深入浅出分布式技术原理/01.开篇词/01"><span>开篇词｜掌握好学习路径，分布式系统原来如此简单</span></a></li></ul></li><li><a href="/blog-architect2/深入浅出分布式技术原理/02.概述篇">02.概述篇</a><ul><li><a href="/blog-architect2/深入浅出分布式技术原理/02.概述篇/01"><span>01｜导读：以前因后果为脉络，串起网状知识体系</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/02.概述篇/02"><span>02｜新的挑战：分布式系统是银弹吗？我看未必！</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/02.概述篇/03"><span>03｜CAP 理论：分布式场景下我们真的只能三选二吗？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐">03.春节加餐</a><ul><li><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/01"><span>春节加餐｜系统性思维，高效学习和工作的利器</span></a></li><li><a aria-current="page" class="active" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02"><span>春节加餐｜深入聊一聊计算机系统的时间</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/03"><span>春节加餐｜技术债如房贷，是否借贷怎样取舍？</span></a></li></ul></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇">04.分布式计算篇</a><ul><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/01"><span>04｜注册发现： AP 系统和 CP 系统哪个更合适？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/02"><span>05｜负载均衡：从状态的角度重新思考负载均衡</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/03"><span>06｜配置中心：如何确保配置的强一致性呢？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/04"><span>07｜分布式锁：所有的分布式锁都是错误的？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/05"><span>08｜重试幂等：让程序 Exactly-once 很难吗？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/06"><span>09 | 雪崩（一）：熔断，让故障自适应地恢复</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/07"><span>10 | 雪崩（二）：限流，抛弃超过设计容量的请求</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/08"><span>11｜雪崩（三）：降级，无奈的丢车保帅之举</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/09"><span>12｜雪崩（四）：扩容，没有用钱解决不了的问题</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/10"><span>13｜可观测性（一）：如何监控一个复杂的分布式系统？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/11"><span>14｜可观测性（二）：如何设计一个高效的告警系统？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/12"><span>15｜故障（一）：预案管理竟然能让被动故障自动恢复？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/13"><span>16｜故障（二）：变更管理，解决主动故障的高效思维方式</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/14"><span>期中测试｜IM 系统设计实战</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/04.分布式计算篇/15"><span>期中测试答案｜这些问题你都答对了吗？</span></a></li></ul></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇">05.分布式存储篇</a><ul><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/01"><span>17｜分片（一）：如何选择最适合的水平分片方式？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/02"><span>18｜分片（二）：垂直分片和混合分片的 trade-off</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/03"><span>19｜复制（一）：主从复制从副本的数据可以读吗？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/04"><span>20｜复制（二）：多主复制的多主副本同时修改了怎么办？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/05"><span>21｜复制（三）：最早的数据复制方式竟然是无主复制？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/06"><span>22｜事务（一）：一致性，事务的集大成者</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/07"><span>23｜事务（二）：原子性，对应用层提供的完美抽象</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/08"><span>24｜事务（三）：隔离性，正确与性能之间权衡的艺术</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/09"><span>25｜事务（四）：持久性，吃一碗粉就付一碗粉的钱</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/10"><span>26｜一致性与共识（一）：数据一致性都有哪些级别？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/11"><span>27｜一致性与共识（二）：它们是鸡生蛋还是蛋生鸡？</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/05.分布式存储篇/12"><span>28｜一致性与共识（三）：共识与事务之间道不明的关系</span></a></li></ul></li><li><a href="/blog-architect2/深入浅出分布式技术原理/06.总结篇">06.总结篇</a><ul><li><a href="/blog-architect2/深入浅出分布式技术原理/06.总结篇/01"><span>29｜分布式计算技术的发展史：从单进程服务到 Service Mesh</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/06.总结篇/02"><span>30｜分布式存储技术的发展史：从 ACID 到 NewSQL</span></a></li></ul></li><li><a href="/blog-architect2/深入浅出分布式技术原理/07.结束语">07.结束语</a><ul><li><a href="/blog-architect2/深入浅出分布式技术原理/07.结束语/01"><span>结束语 ｜在分布式技术的大潮流中自由冲浪吧！</span></a></li><li><a href="/blog-architect2/深入浅出分布式技术原理/07.结束语/02"><span>期末测试｜来赴一场满分之约吧！</span></a></li></ul></li><li><a href="/blog-architect2/深入浅出分布式技术原理/summary">深入浅出分布式技术原理</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="墙上时钟" data-depth="2"><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#墙上时钟"><span>墙上时钟</span></a></li><li title="墙上时钟的同步" data-depth="3"><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#墙上时钟的同步"><span>墙上时钟的同步</span></a></li><li title="闰秒出现的原因" data-depth="3"><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#闰秒出现的原因"><span>闰秒出现的原因</span></a></li><li title="闰秒的处理" data-depth="3"><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#闰秒的处理"><span>闰秒的处理</span></a></li><li title="单调时钟" data-depth="2"><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#单调时钟"><span>单调时钟</span></a></li><li title="时间的管理" data-depth="2"><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#时间的管理"><span>时间的管理</span></a></li><li title="总结" data-depth="2"><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#总结"><span>总结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="春节加餐深入聊一聊计算机系统的时间"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#春节加餐深入聊一聊计算机系统的时间"><span class="icon icon-link"></span></a>春节加餐｜深入聊一聊计算机系统的时间</h1><p>你好，我是陈现麟。</p><p>在专栏“概述篇”第二节课“新的挑战”里，我们讨论过分布式系统在时钟上面临的挑战，今天这期春节加餐，我还会和你深入地聊一聊计算机系统的时间。</p><p>在计算机系统中，时间是一个非常重要的概念，首先它深刻影响着分布式系统的设计。如果我们想要了解如何简化分布式系统的设计，要先从单机系统的时间问题出发。举个例子来说，在构建分布式系统的时候，如果我们能在每个单机系统中，都获得精确的时间点或时间范围，就能大大简化分布式事务等相关的设计。</p><p>其次，在时间方面，分布式系统存在多时钟的问题，理解这个问题之前，也需要先了解单机系统的时间问题。<strong>所以，为了让你深入地了解计算机系统的时间，我们就从单机计算机系统的层面来讨论时间，等你理解以后，再学习分布式系统的时候，就会事半功倍了。</strong></p><p>在计算机系统内部，主要有两种时钟：墙上时钟和单调时钟，它们都可以衡量时间，但却有本质的区别。在这节课中，我将带你了解两种时钟的相关知识，其中的墙上时钟是本节课的重点部分，然后我们再一起探讨如何对两种时钟进行管理。</p><h2 id="墙上时钟"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#墙上时钟"><span class="icon icon-link"></span></a>墙上时钟</h2><p>学习墙上时钟的相关知识，我们要先从墙上时钟的同步入手，了解时间同步出现误差的原因以及现有的解决方案，之后再分析闰秒出现的原因，以及闰秒的处理方式，最后我们会根据处理方式中的“跳跃式调整”的处理逻辑，来分析2012年一个 Linux 服务器宕机的案例。</p><p>墙上时钟又叫钟表时间，顾名思义，和我们平时使用的钟表的时间一样，表示形式为日期与时间。在 Linux 系统中，墙上时钟的表示形式为 UTC 时间，记录的是自公元 1970 年 1 月 1 日 0 时 0 分 0 秒以来的秒数和毫秒数（不含闰秒）。</p><p>Linux 系统需要处理闰秒的逻辑就是因为 Linux 系统使用 UTC 时间，但是系统中记录的 UTC 时间是不含闰秒的。</p><h3 id="墙上时钟的同步"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#墙上时钟的同步"><span class="icon icon-link"></span></a>墙上时钟的同步</h3><p>根据墙上时钟的定义，我们可以发现，墙上时钟的标准是在计算机外部定义的，所以确保墙上时钟的准确性就变成了一个问题。计算机内部的计时器为石英钟，但是它不够精确，随着机器的温度波动，会存在过快或者过慢的问题，<strong>所以依靠计算机自身，来维持墙上时钟的准确性是不可能的，这就是计算机系统内的时间需要与外部时间进行同步的原因</strong>。</p><p>目前普遍采取的一种方式为：计算机与 NTP 时间服务器定期通过网络同步。很明显，这个方式受限于网络时延的影响，一般来说，至少会有 35 毫秒的偏差，最大的时候可能会超过 1 秒。</p><p>在一些对时间精度要求很高的系统中，通过 NTP 进行同步是远远不够的，这时我们可以通过  GPS 接收机，接收标准的墙上时钟，然后在机房内部通过精确时间协议（ PTP ）进行同步。 PTP 是一种高精度时间同步协议，可以达到亚微秒级精度，有资料说可达到 30 纳秒左右的偏差精度，但是它需要网络的节点（交换机）支持 PTP 协议，才能实现纳秒量级的同步。</p><p>在时间同步这个问题上， Google 的做法更酷，通过 GPS 接收机，接收标准的墙上时钟，然后通过机房内部去部署原子钟，使得它的精度可以达到每 2000 万年才误差 1 秒，用这种方式来防止 GPS 接收机的故障。</p><p>接着，再把这些时间协调装置连接到特定数量的主服务器，最后再由主服务器，向整个谷歌网络中运行的其他计算机传输时间读数，即 TrueTime API 。 Google 正是基于上面的时间精度保证，在此基础上实现了第一个可扩展的、全球分布式的数据库 Spanner。</p><h3 id="闰秒出现的原因"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#闰秒出现的原因"><span class="icon icon-link"></span></a>闰秒出现的原因</h3><p>从上述的讨论中，我们可以知道计算机的墙上时钟通过同步机制，确保时间的误差会保持在一个范围以内。虽然它保证了时间精度，但是因为 Linux 系统中，墙上时钟的表示形式为 UTC 时间，而 UTC 时间是不含闰秒的，所以如何处理闰秒就成为了一个重要的问题，那么我们先来想想闰秒出现的原因。</p><p><strong>因为地球自转速率变慢，所以目前的两种时间计量系统：世界时和原子时，它们之间发生了误差，这就是闰秒出现的根本原因</strong>，下面我们就从世界时和原子时这两方面，具体来分析一下。</p><p>世界时（ UT1 ）以地球自转运动来计量时间，它定义地球自转一周为一天，绕太阳公转一周为一年，这对人们的日常生活非常重要。但是，因为地球自转速率正在变慢，世界时的秒长就会有微小的变化，每天会长千分之几秒，也就是说，后一天的 24 小时会比前一天的 24 小时要长千分之几秒，所以用世界时来度量时间，会出现均匀性非常不好的问题。</p><p>原子时取微观世界的铯原子中，两个超精细能级间的跃迁辐射频率来度量时间，精确度非常高，每天快慢不超过千万分之一秒。所以，原子时的均匀性非常好，是度量时间的理想尺度。</p><p>可是，原子时与地球空间位置无关，由于地球自转速率正在变慢，如果在某地区使用原子时，从今天开始计时，那么原子时到了明天凌晨 0：00 的时候，地球还需要等千分之几秒才自转完一周。这样一天一天地累积，就会出现原子时到了凌晨 0：00 这个时候，太阳还在地球正上空的情况，这显然是不符合常识的。</p><p>所以，为了统一原子时与世界时之间的差距，协调世界时（ UTC ）就产生了。从 1972 年 1 月 1 日 0 时起，协调世界时秒长采用原子时秒长，时刻与世界时的时刻之差保持在正负 0.9 秒之内，必要时用阶跃 1 整秒的方式来调整。</p><p><strong>这个 1 整秒的调整，叫做闰秒，如果增加 1 秒就是正闰秒，减少 1 秒就是负闰秒</strong>。 UTC 从 1972 年 1 月起正式成为国际标准时间，它是原子时和世界时这两种时间尺度的结合。</p><h3 id="闰秒的处理"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#闰秒的处理"><span class="icon icon-link"></span></a>闰秒的处理</h3><p>因为 Linux 系统记录着，自公元 1970 年 1 月 1 日 0 时 0 分 0 秒以来的秒数和毫秒数，但是不含闰秒这种情况，导致了在 Linux 系统中每分钟有 60 秒，每天有 86400 秒是系统定义死的。</p><p>所以 Linux 系统需要额外的逻辑来处理闰秒。目前处理闰秒的方式主要有两种，一种是在 Linux 系统上进行跳跃式调整，另一种是在 NTP 服务上进行渐进式调整的 Slew 模型，下面我们具体讲一讲这两种处理逻辑。</p><h4 id="跳跃式调整"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#跳跃式调整"><span class="icon icon-link"></span></a>跳跃式调整</h4><p>首先是在 Linux 系统上进行跳跃式调整，当 UTC 时间插入一个正闰秒后，Linux 系统需要跳过 1 秒，即这一秒时间过去后，在 Linux 的时间管理程序中不应该去计时，因为闰秒的这一秒钟在 Linux 系统中不能被表示。</p><p>但是，当 UTC 时间插入一个负闰秒后，Linux 系统就需要插入 1 秒，即 Linux 的时间管理程序中要增加 1 秒钟的计时。虽然并没有过去 1 秒钟的时间，但是闰秒的这一秒钟在 Linux 系统中是不存在的。</p><p>目前 Linux 系统就是采用这种方式来处理闰秒的，所以在 2012 年 6 月 30 日, UTC 时间插入一个正闰秒的时候，Linux 系统会启动相应的逻辑来处理这个插入的正闰秒，这样就使某些版本的闰秒处理逻辑，触发了一个死锁的 bug，造成了大规模的 Linux 服务器内核死锁而宕机的情况。</p><h4 id="slew-模式"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#slew-模式"><span class="icon icon-link"></span></a>Slew 模式</h4><p>NTP 服务的 Slew 模式并不使用跳跃式修改时间，而是渐进式地调整。比如，当 UTC 时间需要插入一个正闰秒时， NTP 服务就会每秒调整一定的 ms 来缓慢修正时间。这样 Linux 系统从 NTP 服务同步时间的时候，就不会感知闰秒的存在了，内核也就不需要启动闰秒相关的逻辑了。</p><h2 id="单调时钟"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#单调时钟"><span class="icon icon-link"></span></a>单调时钟</h2><p>关于墙上时钟，我们主要讨论的是如何进行时间同步，确保时间精度的问题，而计算机系统中的第二种时钟，<strong>单调时钟是一个相对时钟，不需要与外部的时钟进行同步，较墙上时钟要简单很多</strong>，所以这里我们就简单地分析一下。</p><p>单调时钟总是保证时间是向前的，不会出现墙上时钟的回拨问题，所以它非常适合用来测量持续时间段，比如在一个时间点读取单调时钟的值，完成某项工作后再次获得单调时钟的值，时钟值之差就是两次检测之间的时间间隔。</p><p>到这里，我们可以看出，墙上时钟是绝对时钟，不同计算机节点上的墙上时间可以进行比较，但是它是有误差的，导致比较的结果不可信；而单调时钟是相对时钟，它的绝对值没有任何意义，有可能是计算机自启动以后经历的纳秒数等，所以，比较不同计算机节点上的单调时钟的值是没有意义的。这两点正是分布式系统面临时钟的问题。</p><h2 id="时间的管理"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#时间的管理"><span class="icon icon-link"></span></a>时间的管理</h2><p>前面我们讨论了墙上时钟和单调时钟，你一定很好奇操作系统内部是如何处理时间的，这里你可以先思考两个问题，我们带着问题再具体讨论。第一个问题是：计算机系统是没有时间概念的机器，那么它怎么来计算与管理时间呢？另一个问题是：计算机系统可以提供微秒甚至纳秒，那么它怎么处理这么高精度的时间呢？</p><p>首先，时间的概念对于计算机来说有些模糊，计算机必须在硬件的帮助下才能计算和管理时间。前面说的石英钟就是用来做计算机的系统定时器的，系统定时器以某种固定的频率自行触发时钟中断。由于时钟中断的频率是编程预定的，所以内核知道连续两次时钟中断的间隔时间，这个间隔时间就叫做节拍。<strong>通过时钟中断，内核周期性地更新系统的墙上时钟和单调时钟，从而计算和管理好时间。</strong></p><p>其次，目前系统定时器的中断频率为 1000 HZ，那么计算机能处理的时间精度为 1 ms。然而很多时候需要更加精确的时间，比如 1 微秒，计算机是怎么来解决这个问题的呢？</p><p>其实解决的方式非常简单，在每一次计算机启动的时候，计算机都会计算一次 BogoMIPS 的值，这个值的意义是，<strong>处理器在给定的时间内执行指令数，通过 BogoMIPS 值，计算机就可以得到非常小的精度了</strong>。</p><p>比如在 1 秒内，计算机执行了 N 条指令，那么计算机的精度就可以达到 N 分之一秒。很明显 N 是一个非常大的数目，因此计算机可以得到非常精确的时间了。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#总结"><span class="icon icon-link"></span></a>总结</h2><p>在这节课中，我们从计算机系统内部的两种时钟出发，深入地讨论了时间相关的话题。在墙上时钟这部分，我们讨论了计算机系统时间同步的方式，分析了闰秒产生的原因，以及 Linux 系统应对闰秒的办法，然后概览性地讲了 Linux 系统是通过时钟中断进行时间的计算与管理的，最后分析了 Linux 系统可以提高时间精度的方法。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/深入浅出分布式技术原理/03.春节加餐/02#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>计算机历史上的“千年虫”问题你了解过吗？它和时间有关系吗？</p><p>欢迎你在留言区发表你的看法。如果这节课对你有帮助，也推荐你分享给更多的同事、朋友。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/深入浅出分布式技术原理/03.春节加餐/02.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/29 14:38:21</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-architect2/umi.e65758f7.js"></script>
  </body>
</html>
