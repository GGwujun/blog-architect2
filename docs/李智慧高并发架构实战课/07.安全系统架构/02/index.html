<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-architect2/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-architect2";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>
      18 | 加解密服务平台：如何让敏感数据存储与传输更安全？ - 大师兄
    </title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/李智慧高并发架构实战课/07.安全系统架构/02" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect2/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>架构师<ul><li><a href="/blog-architect2/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-architect2/消息队列进阶">消息队列进阶</a></li><li><a href="/blog-architect2/分布式协议与算法实战">分布式协议与算法实战</a></li><li><a href="/blog-architect2/分布式技术原理与算法解析">分布式技术原理与算法解析</a></li><li><a href="/blog-architect2/分布式数据库30讲">分布式数据库30讲</a></li><li><a href="/blog-architect2/分布式金融架构课">分布式金融架构课</a></li><li><a aria-current="page" class="active" href="/blog-architect2/李智慧高并发架构实战课">李智慧高并发架构实战课</a></li><li><a href="/blog-architect2/深入浅出分布式技术原理">深入浅出分布式技术原理</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect2/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>架构师<ul><li><a href="/blog-architect2/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-architect2/消息队列进阶">消息队列进阶</a></li><li><a href="/blog-architect2/分布式协议与算法实战">分布式协议与算法实战</a></li><li><a href="/blog-architect2/分布式技术原理与算法解析">分布式技术原理与算法解析</a></li><li><a href="/blog-architect2/分布式数据库30讲">分布式数据库30讲</a></li><li><a href="/blog-architect2/分布式金融架构课">分布式金融架构课</a></li><li><a aria-current="page" class="active" href="/blog-architect2/李智慧高并发架构实战课">李智慧高并发架构实战课</a></li><li><a href="/blog-architect2/深入浅出分布式技术原理">深入浅出分布式技术原理</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-architect2/李智慧高并发架构实战课">李智慧高并发架构实战课</a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/01.开篇词">01.开篇词</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/01.开篇词/01"><span>开篇词 | “附身”大厂架构师，身临其境设计高并发系统</span></a></li></ul></li><li><a href="/blog-architect2/李智慧高并发架构实战课/02.前置篇">02.前置篇</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/02.前置篇/01"><span>01 | 软件建模与文档：架构师怎样绘制系统架构蓝图？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/02.前置篇/02"><span>02 | 高并发架构设计方法：面对高并发，怎么对症下药？</span></a></li></ul></li><li><a href="/blog-architect2/李智慧高并发架构实战课/03.高并发系统的海量数据处理架构">03.高并发系统的海量数据处理架构</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/03.高并发系统的海量数据处理架构/01"><span>03 | 短 URL 生成器设计：百亿短 URL 怎样做到无冲突？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/03.高并发系统的海量数据处理架构/02"><span>04 | 网页爬虫设计：如何下载千亿级网页？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/03.高并发系统的海量数据处理架构/03"><span>05 | 网盘系统设计：万亿 GB 网盘如何实现秒传与限速？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/03.高并发系统的海量数据处理架构/04"><span>06 | 短视频系统设计：如何支持三千万用户同时在线看视频？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/03.高并发系统的海量数据处理架构/05"><span>07 | 海量数据处理技术回顾：为什么分布式会遇到 CAP 难题？</span></a></li></ul></li><li><a href="/blog-architect2/李智慧高并发架构实战课/04.高并发系统的高性能架构">04.高并发系统的高性能架构</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/04.高并发系统的高性能架构/01"><span>08 | 秒杀系统设计：你的系统可以应对万人抢购盛况吗？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/04.高并发系统的高性能架构/02"><span>09 | 交友系统设计：哪种地理空间邻近算法更快？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/04.高并发系统的高性能架构/03"><span>10 | 搜索引擎设计：信息搜索怎么避免大海捞针？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/04.高并发系统的高性能架构/04"><span>11 | 反应式编程框架设计：如何使方法调用无阻塞等待？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/04.高并发系统的高性能架构/05"><span>12 | 高性能架构的三板斧：分析系统性能问题从哪里入手？</span></a></li></ul></li><li><a href="/blog-architect2/李智慧高并发架构实战课/05.期中测试">05.期中测试</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/05.期中测试/01"><span>期中测试 | 动手写一篇你自己的设计文档吧！</span></a></li></ul></li><li><a href="/blog-architect2/李智慧高并发架构实战课/06.高并发系统的高可用架构">06.高并发系统的高可用架构</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/06.高并发系统的高可用架构/01"><span>13 | 微博系统设计：怎么应对热点事件的突发访问压力？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/06.高并发系统的高可用架构/02"><span>14 | 百科应用系统设计：机房被火烧了系统还能访问吗？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/06.高并发系统的高可用架构/03"><span>15 | 限流器设计：如何避免超预期的高并发压力压垮系统？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/06.高并发系统的高可用架构/04"><span>16 | 高可用架构的十种武器：怎么度量系统的可用性？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构">07.安全系统架构</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/01"><span>17 | Web 应用防火墙：怎样拦截恶意用户的非法请求？</span></a></li><li><a aria-current="page" class="active" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02"><span>18 | 加解密服务平台：如何让敏感数据存储与传输更安全？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/03"><span>19 | 许可型区块链重构：无中心的区块链怎么做到可信任？</span></a></li></ul></li><li><a href="/blog-architect2/李智慧高并发架构实战课/08.网约车架构">08.网约车架构</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/08.网约车架构/01"><span>20 | 网约车系统设计：怎样设计一个日赚 5 亿的网约车系统？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/08.网约车架构/02"><span>21 | 网约车系统重构：如何用 DDD 重构网约车系统设计？</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/08.网约车架构/03"><span>22 | 大数据平台设计：如何用数据为用户创造价值？</span></a></li></ul></li><li><a href="/blog-architect2/李智慧高并发架构实战课/09.结束语">09.结束语</a><ul><li><a href="/blog-architect2/李智慧高并发架构实战课/09.结束语/01"><span>期中测试获奖用户名单及参考答案：通达系统架构设计</span></a></li><li><a href="/blog-architect2/李智慧高并发架构实战课/09.结束语/02"><span>结束语 | 一个架构师的一天</span></a></li></ul></li><li><a href="/blog-architect2/李智慧高并发架构实战课/summary">李智慧高并发架构实战课</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="需求分析" data-depth="2"><a href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#需求分析"><span>需求分析</span></a></li><li title="概要设计" data-depth="2"><a href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#概要设计"><span>概要设计</span></a></li><li title="详细设计" data-depth="2"><a href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#详细设计"><span>详细设计</span></a></li><li title="小结" data-depth="2"><a href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#小结"><span>小结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="18--加解密服务平台如何让敏感数据存储与传输更安全"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#18--加解密服务平台如何让敏感数据存储与传输更安全"><span class="icon icon-link"></span></a>18 | 加解密服务平台：如何让敏感数据存储与传输更安全？</h1><p>你好，我是李智慧。</p><p>在一个应用系统运行过程中，需要记录、传输很多数据，这些数据有的是非常敏感的，比如用户姓名、手机号码、密码、甚至信用卡号等等。这些数据如果直接存储在数据库，记录在日志中，或者在公网上传输的话，一旦发生数据泄露，不但可能会产生重大的经济损失，还可能会使公司陷入重大的公关与法律危机。公司上下辛苦十几年，一夜回到解放前。</p><p>所以，敏感信息必须进行加密处理，也就是把敏感数据以密文的形式存储、传输。这样即使被黑客攻击，发生数据泄露，被窃取的数据也是密文，获取数据的人无法得到真实的明文内容，敏感数据依然被保护着。而当应用程序需要访问这些密文的时候，只需要进行数据解密，即可还原得到原始明文数据。加解密处理既保证了数据的安全，又保证了数据的正常访问。</p><p>但是，这一切的前提是<strong>加密和解密过程的安全</strong>。加密、解密过程由加密算法、加密密钥、解密算法、解密密钥组成。下图是一个对称加密、解密过程。对称加密密钥和解密密钥是同一个密钥，调用加密算法可将明文加密为密文，调用解密算法可将密文还原为明文。</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimage776877f666f32fb506a4a73cd41a0d51dc68.78ba2316.jpg" alt="图片"/></p><p>所以，如果窃取数据的人知道了解密算法和密钥，即使数据是加密的，也可以轻松对密文进行还原，得到原始的明文数据。而很多时候，解密算法和密钥都以源代码的方式保存在代码仓库里，黑客如果窃取了源代码，或者内部人泄露了源代码，那么所有的秘密就都不是秘密了。</p><p>此外，在某些情况下，我们的系统需要和外部系统进行对称加密数据传输，比如和银行加密传输信用卡卡号，这时候涉及到密钥交换，即我方人员和银行人员对接，直接传递密钥。如果因密钥泄露导致重大经济损失，那么持有密钥的人员将无法自证清白，这又会导致没有人愿意保管密钥。</p><p>因此，我们设计了一个加解密服务系统，系统名称为“Venus”，统一管理所有的加解密算法和密钥。应用程序只需要依赖加解密服务SDK，调用接口进行加解密即可，而真正的算法和密钥在系统服务端进行管理，保证算法和密钥的安全。</p><h2 id="需求分析"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#需求分析"><span class="icon icon-link"></span></a>需求分析</h2><p>一般说来，日常开发中的加解密程序存在如下问题：</p><ol><li>密钥（包括非对称加解密证书）保存在源文件或者配置文件中，存储分散而不安全。</li><li>密钥没有分片交换机制，不能满足高安全级密钥管理和交换的要求。</li><li>密钥缺乏版本管理，不能灵活升级，一旦修改密钥，此前加密的数据就可能无法解密。</li><li>加密解密算法程序不统一，同样算法不同实现，内部系统之间密文不能正确解析。</li><li>部分加解密算法程序使用了弱加解密算法和弱密钥，存在安全隐患。</li></ol><p>为此，我们需要设计开发一个专门的加解密服务及密钥管理系统，以解决以上问题。</p><p>Venus是一个加解密服务系统，核心功能是加解密服务，辅助功能是密钥与算法管理。此外，Venus还需要满足以下非功能需求：</p><ul><li><p><strong>安全性需求</strong><br/>必须保证密钥的安全性，保证没有人能够有机会看到完整的密钥。因此一个密钥至少要拆分成两片，分别存储在两个异构的、物理隔离的存储服务器中 。在需要进行密钥交换的场景中，将密钥至少拆分成两个片段，每个管理密钥的人只能看到一个密钥片段，需要双方所有人分别交接才能完成一次密钥交换。</p></li><li><p><strong>可靠性需求</strong><br/>加解密服务必须可靠，即保证高可用。无论在加解密服务系统服务器宕机、还是网络中断等各种情况下，数据正常加解密都需要得到保障。</p></li><li><p><strong>性能需求</strong><br/>加解密计算的时间延迟主要花费在加解密算法上，也就是说，加载加解密算法程序、获取加解密密钥的时间必须短到可以忽略不计。</p></li></ul><p>根据以上加解密服务系统功能和非功能需求，系统用例图设计如下：</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimage1cba1c0f89yy0163a142385f3a7b11b03fba.aec9526a.jpg" alt="图片"/></p><p>系统主要参与者（Actor）包括：</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimage6ec46eba9d961b89797e68d158ed1d7698c4.0b7d89fa.jpg" alt="图片"/></p><p>系统主要用例过程和功能包括：</p><ol><li>开发工程师使用密钥管理功能为自己开发的应用申请加解密算法和密钥；</li><li>安全工程师使用密钥管理功能审核算法和密钥的强度是否满足数据安全要求；</li><li>（经过授权的）密钥管理者使用密钥管理功能可以查看密钥（的一个分片）；</li><li>应用程序调用加解密功能完成数据的加密、解密；</li><li>加密解密功能和密钥管理功能调用密钥服务功能完成密钥的存储和读取；</li><li>密钥服务功能访问一个安全、可靠的密钥存储系统读写密钥。</li></ol><p>总地说来，Venus应满足如下需求：</p><ol><li>集中、分片密钥存储与管理，多存储备份，保证密钥安全易管理。</li><li>密钥申请者、密钥管理者、密钥访问者，多角色多权限管理，保证密钥管理与传递的安全。</li><li>通过密钥管理控制台完成密钥申请、密钥管理、密钥访问控制等一系列密钥管理操作，实现便捷的密钥管理。</li><li>统一加解密服务API，简单接口，统一算法，为内部系统提供一致的加解密算法实现。</li></ol><h2 id="概要设计"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#概要设计"><span class="icon icon-link"></span></a>概要设计</h2><p>针对上述加解密服务及密钥安全管理的需求，设计加解密服务系统Venus整体结构如下：</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimageea69ea95154aef0b8d3d2975406d95488069.a343faa6.jpg" alt="图片"/></p><p>应用程序调用Venus提供的加解密SDK服务接口，对信息进行加解密，该SDK接口提供了常用的加密解密算法并可根据需求任意扩展。SDK加解密服务接口调用Venus密钥服务器的密钥服务，以取得加解密密钥，并缓存在本地。而密钥服务器中的密钥则来自多个密钥存储服务器，一个密钥分片后存储在多个存储服务器中，每个服务器都由不同的人负责管理。密钥申请者、密钥管理者、安全审核人员通过密钥管理控制台管理更新密钥，每个人各司其事，没有人能查看完整的密钥信息。</p><h4 id="部署模型"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#部署模型"><span class="icon icon-link"></span></a>部署模型</h4><p>Venus部署模型如图：</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimage0acd0a74fc0354a422b74a7a22e3ea8125cd.80399109.jpg" alt="图片"/></p><p>Venus系统的核心服务器是Key Server服务器，提供密钥管理服务。密钥分片存储在文件服务器File Store和数据库DB中。</p><p>使用Venus加解密服务的应用程序（Application）部署在应用程序服务器（App Server）中，依赖Venus提供的SDK API进行数据加解密。而Venus SDK 则是访问密钥服务器（Key Server）来获取加解密算法代码和密钥。</p><p>安全起见，密钥将被分片存储在文件服务器（Key File Store）和数据库服务器（Key DB）中。所以Key Server服务器中部署了密钥管理组件（Key Manager），用于访问数据库中的应用程序密钥元信息（Key Meta Data），以此获取密钥分片存储信息。Key Server服务器根据这些信息访问File Store和DB，获取密钥分片，并把分片拼接为完整密钥，最终返回给SDK。</p><p>此外，密钥管理控制台（Key Console）提供一个web页面，供开发工程师、安全工程师、密钥管理者进行密钥申请、更新、审核、查看等操作。</p><h4 id="加解密调用时序图"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#加解密调用时序图"><span class="icon icon-link"></span></a>加解密调用时序图</h4><p>加解密调用过程如下时序图所示。</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimage510b517ec6bf8ea55ce12a873083e0bbyy0b.fd0649c8.jpg" alt="图片"/></p><ol><li>应用程序App调用Venus SDK对数据进行加密（解密）。</li><li>SDK检查在本地是否有缓存加解密需要的密钥和加解密算法代码，如果有缓存，就直接使用该算法和密钥进行加解密。</li><li>如果本地没有缓存密钥和算法，请求远程服务器返回密钥和算法。</li><li>部署在Venus服务器的Key Manager收到请求后，访问数据库，检查该应用配置的密钥和算法Meta信息。</li><li>数据库返回的Mata信息中包括了密钥的分片信息和存储位置，Key Manager访问文件服务器和数据库，获取密钥分片，并将多个分片合并成一个完整密钥，返回给客户端SDK。</li><li>SDK收到密钥后，缓存在本地进程内存中，并完成对App加解密调用的处理。</li></ol><p>通过该设计，我们可以看到，Venus对密钥进行分片存储，不同存储服务器由不同运维人员管理。就算需要进行密钥交换，那么参与交换的人员，每个人也只能获得一个密钥分片，无法得到完整的密钥，这样就保证了密钥的安全性。</p><p>密钥缓存在SDK所在的进程（也就是应用程序App所在的进程）中，只有第一次调用时会访问远程的Venus服务器，其他调用只访问本进程缓存。因此加解密的性能只受加解密的数据大小和算法的影响，不受Venus服务的性能影响，满足了性能要求。</p><p>同时，由于密钥在缓存中，如果Venus服务器临时宕机，或者网络通信中断，也不会影响到应用程序的正常使用，保证了Venus的可靠性。但是如果Venus服务器长时间宕机，那么应用重新启动，本地缓存被清空，就需要重新请求密钥，这时候应用就不可用了。那么Venus如何在这种情况下仍然保证高可用呢？</p><p>解决方案就是对Venus服务器、数据库和文件服务器做高可用备份。Venus服务器部署2-3台服务器，构建一个小型集群，SDK通过软负载均衡访问Venus服务器集群，若发现某台Venus服务器宕机，就进行失效转移。同样，数据库和文件服务器也需要做主从备份。</p><h2 id="详细设计"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#详细设计"><span class="icon icon-link"></span></a>详细设计</h2><p>Venus详细设计主要关注SDK核心类设计。其他的例如数据库结构设计、服务器密钥管理Console设计等，这里不做展开。</p><h4 id="密钥领域模型"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#密钥领域模型"><span class="icon icon-link"></span></a>密钥领域模型</h4><p>为了便于SDK缓存、管理密钥信息以及SDK与Venus服务端传输密钥信息，我们设计了一个密钥领域模型，如下图：</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimagec90dc9cd240b8f27e38e0027656ed512da0d.d517a6f3.jpg" alt="图片"/></p><ol><li>一个应用程序使用的所有密钥信息都记录在KeyBox对象中，KeyBox对象中有一个keySuitMap成员变量，这个map的key是密钥名称，value是一个KeySuit对象。</li><li>KeySuit类中有一个keyChainMap成员变量，这个map类的key是版本号，value是一个KeyChain对象。Venus因为安全性需求，需要支持多版本的密钥。也就是说，对同一类数据的加密密钥过一段时间就会进行版本升级，这样即使密钥泄露，也只会影响一段时间的数据，不会导致所有的数据都被解密。</li><li>KeySuit类的另一个成员变量currentVersion记录当前最新的密钥版本号，也就是当前用来进行数据加密的密钥版本号。而解密的时候，则需要从密文数据中提取出加密密钥版本号（或者由应用程序自己记录密钥版本号，在解密的时候提供给Venus SDK API），根据这个版本号获取对应的解密密钥。</li><li>具体每个版本的密钥信息记录在KeyChain中，包含了密钥名称name、密钥版本号version、加入本地缓存的时间cache_time、该版本密钥创建的时间versionTime、对应的加解密算法algorithm，当然，还有最重要的密钥分片列表keyChipList，里面按序记录着这个密钥的分片信息。</li><li>KeyChip记录每个密钥分片，包括分片编号no，以及分片密钥内容chip。</li></ol><h4 id="核心服务类设计"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#核心服务类设计"><span class="icon icon-link"></span></a>核心服务类设计</h4><p>应用程序通过调用加解密API VenusService完成数据加解密。如下图：</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimagef0a5f012b372fa95b2468a0042e37yyb5ca5.7856059d.jpg" alt="图片"/></p><ol><li>Venus SDK的核心类是VenusService，应用程序调用该对象的encrypt方法进行加密，decrypt方法进行解密。应用程序需要构造VenusData对象，将加解密数据传给VenusService，VenusService加解密完成后创建一个新的VenusData对象，将加解密的结果写入该对象并返回。VenusData成员变量在后面详细讲解。</li><li>VenusService通过VenusConnector类连接Venus服务器获取密钥KeyBox和算法Algorithm，并调用Algorithm的对应方法完成加解密。</li></ol><p>以加密为例，具体处理过程时序图如下：</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimage256e25fb2958a3f84c3f2b09dd09d35de96e.d1a46ef5.jpg" alt="图片"/></p><p>首先，应用程序App创建VenusData对象，并将待加密数据写入该对象。接着，App调用VenusService的encrypt方法进行加密，VenusService检查加密需要的密钥和算法是否已经有缓存，如果没有，就调用VenusConnector请求服务器，返回密钥和算法。VenusConnector将根据返回的算法字节码来构造加密算法的实例对象，同时根据返回的密钥构造相关密钥对象，并写入KeyBox，完成更新。</p><p>下一步，VenusService会根据更新后的KeyBox中的密钥和算法进行加密，并将加密结果写入VenusData。最后，应用程序App从返回的VenusData中获取加密后的数据即可。</p><h4 id="加解密数据接口venusdata设计"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#加解密数据接口venusdata设计"><span class="icon icon-link"></span></a>加解密数据接口VenusData设计</h4><p>VenusData用于表示Venus加解密操作输入和输出的数据，也就是说，加解密的时候构造VenusData对象调用Service对应的方法，加解密完成后返回值还是一个VenusData对象。</p><p>VenusData包含的属性如下图：</p><p><img src="/blog-architect2/static/httpsstatic001geekbangorgresourceimagee5a0e595e1f0882df1ea415e841f6657f2a0.516c8936.jpg" alt="图片"/></p><p>VenusData用作输入时：</p><ol><li>属性bytes和text只要设置一个，即要么处理的是二进制bytes数据，要么是Striing数据，如果两个都设置了，Venus会抛出异常。</li><li>属性version可以不设置（即null），表示Venus操作使用的密钥版本是当前版本。</li><li>属性outputWithText表示输出的VenusData是否处理为text类型，缺省值是true。</li><li>属性dataWithVersion表示加密后的VenusData的bytes和text 中是否包含使用密钥的版本信息，这样在解密的时候可以不指定版本，缺省值是false。</li></ol><p>如果dataWithVersion设置为true，即表示加密后密文内包含版本号，这种情况下，VenusService需要在密文头部增加3个字节的版本号信息，其中头两个字节为固定的magic code：0x5E、0x23，第三个字节为版本号（也就是说，密钥版本号只占用一个字节，最多支持256个版本）。</p><p>VenusData用作输出时，Venus会设置属性keyName（和输入时的值一样）、version、 bytes、 outputWithText、dataWithVersion（和输入时的值一样），并根据输入的 outputWithText决定是否设置text属性。</p><h4 id="测试用例代码demo"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#测试用例代码demo"><span class="icon icon-link"></span></a>测试用例代码demo</h4><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static void testVenusService() throws Exception {</span></div><div class="token-line"><span class="token plain">            // 准备数据</span></div><div class="token-line"><span class="token plain">            VenusData data1 = new VenusData();</span></div><div class="token-line"><span class="token plain">            data1.setKeyName(&quot;aeskey1&quot;);</span></div><div class="token-line"><span class="token plain">            data1.setText(&quot;PlainText&quot;);</span></div><div class="token-line"><span class="token plain">            // 加密操作</span></div><div class="token-line"><span class="token plain">            VenusData encrypt = VenusService.encrypt(data1);</span></div><div class="token-line"><span class="token plain">            System.out.printf(&quot;Key Name: %s, Secret Text: %s, Version: %d.\n&quot;, encrypt.getKeyName(),</span></div><div class="token-line"><span class="token plain">                    encrypt.getText(), encrypt.getVersion());</span></div><div class="token-line"><span class="token plain">            // 准备数据</span></div><div class="token-line"><span class="token plain">            VenusData data2 = new VenusData();</span></div><div class="token-line"><span class="token plain">            data2.setKeyName(&quot;aeskey1&quot;);</span></div><div class="token-line"><span class="token plain">            data2.setBytes(encrypt.getBytes());</span></div><div class="token-line"><span class="token plain">            data2.setVersion(encrypt.getVersion());</span></div><div class="token-line"><span class="token plain">            // 解密操作</span></div><div class="token-line"><span class="token plain">            VenusData decrypt = VenusService.decrypt(data2);</span></div><div class="token-line"><span class="token plain">            System.out.printf(&quot;Key Name: %s, Plain Text: %s, Version: %d.\n&quot;, decrypt.getKeyName(),</span></div><div class="token-line"><span class="token plain">                    decrypt.getText(), decrypt.getVersion());</span></div><div class="token-line"><span class="token plain">        }</span></div></pre></div><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#小结"><span class="icon icon-link"></span></a>小结</h2><p>随着国家信息安全法规的逐步完善以及用户对个人信息安全意识的增强，互联网信息安全也变得越来越重要了。据估计，我国每年涉及互联网信息安全的灰色产业达1000亿，很多应用在自己不知情的情况下，已经被窃取了信息并进行交易了。</p><p>Venus是根据某大厂真实设计改编的，如果你所在的公司还没有类似安全的加解密服务平台，不妨参考Venus的设计，开发实现一个这样的系统。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-architect2/李智慧高并发架构实战课/07.安全系统架构/02#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>在你的工作中使用了哪些加密算法，算法以及密钥是否安全？有什么改进的思路吗？</p><p>欢迎在评论区分享你的思考，我们共同进步。</p><blockquote><p>【编辑温馨提示】4月10日12点前，提交<a target="_blank" rel="noopener noreferrer" href="http://https//time.geekbang.org/column/article/495175">期中测试<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>作业，有机会获得老师精心准备的奖励哦~</p></blockquote></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/李智慧高并发架构实战课/07.安全系统架构/02.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/29 14:38:21</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-architect2/umi.e65758f7.js"></script>
  </body>
</html>
